<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M400 Ground Station</title>

<!-- mpegts.js for HTTP-FLV playback (successor to flv.js) -->
<script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.js"></script>
<!-- Leaflet for mini-map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap');

  :root {
    --bg: #000000;
    --surface: #0d0d12;
    --border: #1a1a24;
    --text: #d4d4dc;
    --dim: #555566;
    --green: #00e676;
    --green-dim: rgba(0, 230, 118, 0.15);
    --red: #ff3d5a;
    --amber: #ffab40;
    --cyan: #00e5ff;
    --font-mono: 'JetBrains Mono', monospace;
    --font-body: 'Inter', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    height: 44px;
    flex-shrink: 0;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 600;
    letter-spacing: -0.5px;
  }

  .logo span { color: var(--green); }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 10px;
    border-radius: 100px;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    background: rgba(255, 61, 90, 0.1);
    border: 1px solid rgba(255, 61, 90, 0.3);
    color: var(--red);
  }

  .status-pill.live {
    background: rgba(0, 230, 118, 0.1);
    border-color: rgba(0, 230, 118, 0.3);
    color: var(--green);
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--red);
  }

  .status-pill.live .status-dot {
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse 2s ease infinite;
  }

  @keyframes pulse { 50% { opacity: 0.4; } }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 16px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--dim);
  }

  .latency-badge {
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
  }

  .latency-badge.good { color: var(--green); border-color: rgba(0,230,118,0.3); }
  .latency-badge.warn { color: var(--amber); border-color: rgba(255,171,64,0.3); }
  .latency-badge.bad { color: var(--red); border-color: rgba(255,61,90,0.3); }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ VIDEO AREA ‚îÄ‚îÄ‚îÄ */
  .video-area {
    flex: 1;
    position: relative;
    background: #000;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .no-signal {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--dim);
    font-family: var(--font-mono);
    font-size: 13px;
    background: rgba(0,0,0,0.8);
    z-index: 5;
  }

  .no-signal.hidden { display: none; }

  /* ‚îÄ‚îÄ‚îÄ VIDEO OVERLAY: HUD ‚îÄ‚îÄ‚îÄ */
  .hud {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 10;
  }

  /* Top-left: flight mode + time */
  .hud-top-left {
    position: absolute;
    top: 16px;
    left: 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .hud-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 500;
    padding: 4px 10px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.08);
    width: fit-content;
  }

  .hud-tag .icon { font-size: 14px; }

  /* Top-right: battery + signal */
  .hud-top-right {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
  }

  .battery-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 600;
    padding: 4px 10px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.08);
  }

  .battery-icon {
    width: 28px;
    height: 14px;
    border: 1.5px solid currentColor;
    border-radius: 2px;
    position: relative;
    display: flex;
    align-items: center;
    padding: 2px;
  }

  .battery-icon::after {
    content: '';
    position: absolute;
    right: -5px;
    width: 3px;
    height: 8px;
    background: currentColor;
    border-radius: 0 1px 1px 0;
  }

  .battery-fill {
    height: 100%;
    border-radius: 1px;
    transition: width 0.5s, background 0.5s;
  }

  .signal-bar {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 14px;
    padding: 4px 10px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.08);
  }

  .signal-bar .bar {
    width: 3px;
    background: var(--dim);
    border-radius: 1px;
  }

  .signal-bar .bar.active { background: var(--green); }

  /* Bottom-center: speed + altitude tape */
  .hud-bottom-center {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 40px;
    align-items: flex-end;
  }

  .gauge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-family: var(--font-mono);
    padding: 8px 16px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.08);
    min-width: 100px;
  }

  .gauge-value {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    color: #fff;
  }

  .gauge-unit {
    font-size: 11px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .gauge-label {
    font-size: 10px;
    color: var(--cyan);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  /* Bottom-left: GPS coords */
  .hud-bottom-left {
    position: absolute;
    bottom: 16px;
    left: 16px;
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 6px 10px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--dim);
  }

  .hud-bottom-left .coords {
    color: var(--text);
    font-weight: 500;
  }

  /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
  .sidebar {
    width: 300px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
  }

  .sidebar-section {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-section h3 {
    font-family: var(--font-mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 12px;
  }

  /* Mini Map */
  .map-container {
    width: 100%;
    height: 200px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  #minimap { height: 100%; width: 100%; }

  /* Telemetry Rows */
  .telem-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }

  .telem-row:last-child { border-bottom: none; }

  .telem-row .label {
    color: var(--dim);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .telem-row .value {
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  .telem-row .value.green { color: var(--green); }
  .telem-row .value.amber { color: var(--amber); }
  .telem-row .value.red { color: var(--red); }

  /* Connection Info */
  .conn-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--green);
    word-break: break-all;
    margin-bottom: 6px;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .conn-box:hover { border-color: var(--green); }

  .conn-label {
    font-family: var(--font-mono);
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--dim);
    margin-bottom: 4px;
  }

  .conn-group { margin-bottom: 10px; }
  .conn-group:last-child { margin-bottom: 0; }

  /* Protocol switch */
  .proto-switch {
    display: flex;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 12px;
  }

  .proto-btn {
    flex: 1;
    padding: 6px 0;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    background: var(--bg);
    color: var(--dim);
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .proto-btn.active {
    background: var(--green-dim);
    color: var(--green);
  }

  .proto-btn:not(:last-child) {
    border-right: 1px solid var(--border);
  }

  /* Leaflet dark theme overrides */
  .leaflet-container { background: #0a0a0f; }
  .leaflet-control-attribution { display: none; }
  .leaflet-control-zoom { display: none; }

  /* Drone marker pulse */
  .drone-marker {
    width: 16px;
    height: 16px;
    background: var(--cyan);
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 12px var(--cyan), 0 0 24px rgba(0, 229, 255, 0.3);
    position: relative;
  }

  .drone-marker::after {
    content: '';
    position: absolute;
    inset: -8px;
    border-radius: 50%;
    border: 1.5px solid rgba(0, 229, 255, 0.4);
    animation: ping 2s ease infinite;
  }

  @keyframes ping {
    0% { transform: scale(0.8); opacity: 1; }
    100% { transform: scale(2); opacity: 0; }
  }

  /* Heading indicator on marker */
  .heading-indicator {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 8px solid var(--cyan);
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ -->
<div class="topbar">
  <div class="topbar-left">
    <div class="logo"><span>‚óÜ</span> M400 GROUND STATION</div>
    <div class="status-pill" id="statusPill">
      <div class="status-dot"></div>
      <span id="statusText">NO SIGNAL</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="latency-badge" id="latencyBadge">LATENCY: ‚Äî</div>
    <div id="clock"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ -->
<div class="main">

  <!-- VIDEO -->
  <div class="video-area">
    <video id="video" muted autoplay playsinline></video>
    <div class="no-signal" id="noSignal">
      <svg width="48" height="48" fill="none" stroke="#555" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z"/></svg>
      <span>Waiting for RTMP stream‚Ä¶</span>
      <span style="font-size:11px;color:#444">rtmp://<span class="host-ph"></span>/live/stream</span>
    </div>

    <!-- HUD OVERLAY -->
    <div class="hud" id="hud">
      <!-- Top Left: Flight mode + time -->
      <div class="hud-top-left">
        <div class="hud-tag"><span class="icon">üõ∞</span> <span id="hudMode">‚Äî</span></div>
        <div class="hud-tag"><span class="icon">‚è±</span> <span id="hudFlightTime">00:00</span></div>
        <div class="hud-tag"><span class="icon">üì°</span> <span id="hudSats">‚Äî sats</span></div>
      </div>

      <!-- Top Right: Battery + Signal -->
      <div class="hud-top-right">
        <div class="battery-bar">
          <div class="battery-icon">
            <div class="battery-fill" id="batteryFill" style="width:0%;background:var(--green)"></div>
          </div>
          <span id="hudBattery">‚Äî%</span>
        </div>
        <div class="signal-bar" id="signalBars">
          <div class="bar" style="height:4px"></div>
          <div class="bar" style="height:7px"></div>
          <div class="bar" style="height:10px"></div>
          <div class="bar" style="height:13px"></div>
          <div class="bar" style="height:16px"></div>
        </div>
      </div>

      <!-- Bottom Center: Speed + Altitude -->
      <div class="hud-bottom-center">
        <div class="gauge">
          <div class="gauge-label">Speed</div>
          <div class="gauge-value" id="hudSpeed">‚Äî</div>
          <div class="gauge-unit">m/s</div>
        </div>
        <div class="gauge">
          <div class="gauge-label">Altitude</div>
          <div class="gauge-value" id="hudAlt">‚Äî</div>
          <div class="gauge-unit">m agl</div>
        </div>
        <div class="gauge">
          <div class="gauge-label">V/Speed</div>
          <div class="gauge-value" id="hudVSpeed">‚Äî</div>
          <div class="gauge-unit">m/s</div>
        </div>
      </div>

      <!-- Bottom Left: GPS -->
      <div class="hud-bottom-left">
        <span>GPS </span>
        <span class="coords" id="hudCoords">‚Äî, ‚Äî</span>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">

    <!-- Protocol Switch -->
    <div class="sidebar-section">
      <h3>Playback</h3>
      <div class="proto-switch">
        <button class="proto-btn active" id="btnFlv" onclick="switchProto('flv')">FLV (Low Lat)</button>
        <button class="proto-btn" id="btnHls" onclick="switchProto('hls')">HLS (Compat)</button>
      </div>
      <div class="conn-group">
        <div class="conn-label">RTMP Ingest</div>
        <div class="conn-box" onclick="copy(this)">rtmp://<span class="host-ph"></span>/live/stream</div>
      </div>
      <div class="conn-group">
        <div class="conn-label">Stream Playback</div>
        <div class="conn-box" onclick="copy(this)" id="playbackUrl">http://<span class="host-ph"></span>:8080/live?app=live&stream=stream</div>
      </div>
    </div>

    <!-- Mini Map -->
    <div class="sidebar-section">
      <h3>Position</h3>
      <div class="map-container">
        <div id="minimap"></div>
      </div>
    </div>

    <!-- Telemetry Details -->
    <div class="sidebar-section">
      <h3>Telemetry</h3>
      <div class="telem-row">
        <span class="label">üìç Latitude</span>
        <span class="value" id="tLat">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üìç Longitude</span>
        <span class="value" id="tLng">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üìè Altitude</span>
        <span class="value" id="tAlt">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üí® Speed</span>
        <span class="value" id="tSpeed">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">‚ÜïÔ∏è V/Speed</span>
        <span class="value" id="tVSpeed">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üß≠ Heading</span>
        <span class="value" id="tHeading">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üîã Battery</span>
        <span class="value" id="tBattery">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üì° Signal</span>
        <span class="value" id="tSignal">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">üõ∞ Satellites</span>
        <span class="value" id="tSats">‚Äî</span>
      </div>
      <div class="telem-row">
        <span class="label">‚è± Flight Time</span>
        <span class="value" id="tFlightTime">‚Äî</span>
      </div>
    </div>

  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ GLOBALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const host = location.hostname;
document.querySelectorAll('.host-ph').forEach(el => el.textContent = host);

let player = null;
let currentProto = 'flv';
const video = document.getElementById('video');
const noSignal = document.getElementById('noSignal');
const statusPill = document.getElementById('statusPill');
const statusText = document.getElementById('statusText');

function copy(el) {
  navigator.clipboard.writeText(el.textContent.trim());
  el.style.borderColor = 'var(--green)';
  setTimeout(() => el.style.borderColor = '', 1000);
}

// ‚îÄ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(() => {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('en-GB', { hour12: false });
}, 1000);

// ‚îÄ‚îÄ‚îÄ VIDEO PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setLive(on) {
  noSignal.classList.toggle('hidden', on);
  statusPill.classList.toggle('live', on);
  statusText.textContent = on ? 'LIVE' : 'NO SIGNAL';
}

function destroyPlayer() {
  if (player) {
    player.pause();
    player.unload();
    player.detachMediaElement();
    player.destroy();
    player = null;
  }
  video.src = '';
}

function startFlv() {
  destroyPlayer();
  if (!mpegts.isSupported()) {
    console.error('mpegts.js not supported');
    return;
  }

  player = mpegts.createPlayer({
    type: 'flv',
    isLive: true,
    url: `http://${host}:8080/live?app=live&stream=stream`
  }, {
    // ‚îÄ‚îÄ AGGRESSIVE LOW-LATENCY SETTINGS ‚îÄ‚îÄ
    enableStashBuffer: false,     // NO buffering
    stashInitialSize: 128,        // Tiny initial stash (bytes)
    enableWorker: true,           // Offload to web worker
    autoCleanupSourceBuffer: true,
    autoCleanupMaxBackwardDuration: 2,
    autoCleanupMinBackwardDuration: 1,
    lazyLoad: false,
    lazyLoadMaxDuration: 1,
    lazyLoadRecoverDuration: 0.5,
    deferLoadAfterSourceOpen: false,
    liveBufferLatencyChasing: true,     // KEY: chase live edge
    liveBufferLatencyMaxLatency: 1.5,   // Max 1.5s behind live
    liveBufferLatencyMinRemain: 0.3,    // Keep 0.3s minimum buffer
    liveSync: true,
  });

  player.attachMediaElement(video);
  player.load();
  player.play();

  player.on(mpegts.Events.MEDIA_INFO, () => setLive(true));
  player.on(mpegts.Events.ERROR, () => {
    setLive(false);
    setTimeout(() => startFlv(), 2000);
  });

  // Latency chasing: if we fall behind, skip ahead
  setInterval(() => {
    if (video.buffered.length > 0) {
      const end = video.buffered.end(video.buffered.length - 1);
      const lag = end - video.currentTime;

      // Update latency badge
      const badge = document.getElementById('latencyBadge');
      badge.textContent = `LATENCY: ${lag.toFixed(1)}s`;
      badge.className = 'latency-badge ' + (lag < 2 ? 'good' : lag < 4 ? 'warn' : 'bad');

      // If more than 2 seconds behind, jump to live edge
      if (lag > 2) {
        video.currentTime = end - 0.3;
      }
    }
  }, 500);
}

function startHls() {
  destroyPlayer();
  // Native HLS or fallback
  video.src = `http://${host}:8080/hls/stream.m3u8`;
  video.play().catch(() => {});

  video.onplaying = () => setLive(true);
  video.onerror = () => {
    setLive(false);
    setTimeout(() => startHls(), 3000);
  };

  // Update latency badge for HLS
  setInterval(() => {
    if (video.buffered.length > 0) {
      const lag = video.buffered.end(video.buffered.length - 1) - video.currentTime;
      const badge = document.getElementById('latencyBadge');
      badge.textContent = `LATENCY: ${lag.toFixed(1)}s`;
      badge.className = 'latency-badge ' + (lag < 3 ? 'good' : lag < 6 ? 'warn' : 'bad');
    }
  }, 1000);
}

function switchProto(proto) {
  currentProto = proto;
  document.getElementById('btnFlv').classList.toggle('active', proto === 'flv');
  document.getElementById('btnHls').classList.toggle('active', proto === 'hls');

  const urlBox = document.getElementById('playbackUrl');
  if (proto === 'flv') {
    urlBox.innerHTML = `http://<span class="host-ph">${host}</span>:8080/live?app=live&stream=stream`;
    startFlv();
  } else {
    urlBox.innerHTML = `http://<span class="host-ph">${host}</span>:8080/hls/stream.m3u8`;
    startHls();
  }
}

// ‚îÄ‚îÄ‚îÄ MINI MAP (Leaflet) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = L.map('minimap', {
  zoomControl: false,
  attributionControl: false,
  dragging: true,
  scrollWheelZoom: true,
}).setView([6.5244, 3.3792], 15); // Default: Lagos

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
}).addTo(map);

// Custom drone icon
const droneIcon = L.divIcon({
  className: '',
  html: `<div class="drone-marker" id="droneMarkerIcon"><div class="heading-indicator"></div></div>`,
  iconSize: [16, 16],
  iconAnchor: [8, 8],
});

let droneMarker = L.marker([6.5244, 3.3792], { icon: droneIcon }).addTo(map);
let flightPath = L.polyline([], { color: '#00e5ff', weight: 2, opacity: 0.6 }).addTo(map);
let pathPoints = [];

// ‚îÄ‚îÄ‚îÄ TELEMETRY WEBSOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ws = null;
let wsReconnectTimer = null;

function connectTelemetry() {
  const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${wsProto}://${host}:8080/ws?role=viewer`);

  ws.onopen = () => {
    console.log('[TELEMETRY] Connected');
    if (wsReconnectTimer) clearInterval(wsReconnectTimer);
  };

  ws.onmessage = (e) => {
    try {
      const d = JSON.parse(e.data);

      if (d.type === 'drone_disconnected') {
        console.log('[TELEMETRY] Drone disconnected');
        return;
      }

      updateTelemetry(d);
    } catch (err) {
      console.error('[TELEMETRY] Parse error:', err);
    }
  };

  ws.onclose = () => {
    console.log('[TELEMETRY] Disconnected, reconnecting...');
    wsReconnectTimer = setTimeout(connectTelemetry, 2000);
  };

  ws.onerror = () => ws.close();
}

function updateTelemetry(d) {
  // ‚îÄ‚îÄ HUD Overlay ‚îÄ‚îÄ
  if (d.speed != null) document.getElementById('hudSpeed').textContent = d.speed.toFixed(1);
  if (d.alt != null) document.getElementById('hudAlt').textContent = d.alt.toFixed(0);
  if (d.vSpeed != null) document.getElementById('hudVSpeed').textContent = (d.vSpeed >= 0 ? '+' : '') + d.vSpeed.toFixed(1);
  if (d.flightMode) document.getElementById('hudMode').textContent = d.flightMode;
  if (d.satellites != null) document.getElementById('hudSats').textContent = d.satellites + ' sats';

  if (d.lat != null && d.lng != null) {
    document.getElementById('hudCoords').textContent =
      d.lat.toFixed(6) + ', ' + d.lng.toFixed(6);
  }

  // Battery HUD
  if (d.battery != null) {
    document.getElementById('hudBattery').textContent = d.battery + '%';
    const fill = document.getElementById('batteryFill');
    fill.style.width = d.battery + '%';
    fill.style.background = d.battery > 30 ? 'var(--green)' : d.battery > 15 ? 'var(--amber)' : 'var(--red)';
  }

  // Signal bars
  if (d.signal != null) {
    const bars = document.querySelectorAll('#signalBars .bar');
    const level = Math.ceil(d.signal / 20); // 0-5
    bars.forEach((bar, i) => bar.classList.toggle('active', i < level));
  }

  // Flight time
  if (d.flightTime != null) {
    const m = Math.floor(d.flightTime / 60);
    const s = d.flightTime % 60;
    document.getElementById('hudFlightTime').textContent =
      String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  // ‚îÄ‚îÄ Sidebar Telemetry ‚îÄ‚îÄ
  if (d.lat != null) document.getElementById('tLat').textContent = d.lat.toFixed(6) + '¬∞';
  if (d.lng != null) document.getElementById('tLng').textContent = d.lng.toFixed(6) + '¬∞';
  if (d.alt != null) document.getElementById('tAlt').textContent = d.alt.toFixed(1) + ' m';
  if (d.speed != null) document.getElementById('tSpeed').textContent = d.speed.toFixed(1) + ' m/s';
  if (d.vSpeed != null) document.getElementById('tVSpeed').textContent = d.vSpeed.toFixed(1) + ' m/s';
  if (d.heading != null) document.getElementById('tHeading').textContent = d.heading.toFixed(0) + '¬∞';
  if (d.satellites != null) document.getElementById('tSats').textContent = d.satellites;

  if (d.battery != null) {
    const el = document.getElementById('tBattery');
    el.textContent = d.battery + '%';
    el.className = 'value ' + (d.battery > 30 ? 'green' : d.battery > 15 ? 'amber' : 'red');
  }

  if (d.signal != null) {
    const el = document.getElementById('tSignal');
    el.textContent = d.signal + '%';
    el.className = 'value ' + (d.signal > 60 ? 'green' : d.signal > 30 ? 'amber' : 'red');
  }

  if (d.flightTime != null) {
    const m = Math.floor(d.flightTime / 60);
    const s = d.flightTime % 60;
    document.getElementById('tFlightTime').textContent =
      String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  // ‚îÄ‚îÄ Mini Map ‚îÄ‚îÄ
  if (d.lat != null && d.lng != null) {
    const pos = [d.lat, d.lng];
    droneMarker.setLatLng(pos);
    map.panTo(pos, { animate: true, duration: 0.3 });

    // Flight path trail
    pathPoints.push(pos);
    if (pathPoints.length > 500) pathPoints.shift(); // Keep last 500 points
    flightPath.setLatLngs(pathPoints);

    // Rotate heading indicator
    if (d.heading != null) {
      const markerEl = document.getElementById('droneMarkerIcon');
      if (markerEl) {
        markerEl.style.transform = `rotate(${d.heading}deg)`;
      }
    }
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
startFlv();
connectTelemetry();

// Invalidate map size after layout settles
setTimeout(() => map.invalidateSize(), 500);
</script>
</body>
</html>
